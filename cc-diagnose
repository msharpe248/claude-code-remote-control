#!/bin/bash
# cc-diagnose - Diagnose Claude Code Remote Control setup
#
# Checks dependencies, permissions, config, and common issues.

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ISSUES=0
WARNINGS=0

ok() {
    echo -e "  ${GREEN}✓${NC} $1"
}

warn() {
    echo -e "  ${YELLOW}⚠${NC} $1"
    ((WARNINGS++)) || true
}

fail() {
    echo -e "  ${RED}✗${NC} $1"
    ((ISSUES++)) || true
}

info() {
    echo -e "  ${CYAN}ℹ${NC} $1"
}

section() {
    echo ""
    echo -e "${BOLD}$1${NC}"
}

# Check a command exists
check_cmd() {
    local cmd=$1
    local name=${2:-$1}
    local install_hint=$3

    if command -v "$cmd" &>/dev/null; then
        local version=$($cmd --version 2>&1 | head -1 || echo "installed")
        ok "$name: $version"
        return 0
    else
        fail "$name: not installed"
        [ -n "$install_hint" ] && info "  Install: $install_hint"
        return 1
    fi
}

# Main
main() {
    echo -e "${BOLD}${BLUE}Claude Code Remote Control - Diagnostics${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════${NC}"

    # ─────────────────────────────────────────────────────────────────────────
    section "Dependencies"

    check_cmd python3 "Python 3" "brew install python3"

    if check_cmd claude "Claude CLI" "npm install -g @anthropic-ai/claude-code"; then
        # Check claude version
        local claude_ver=$(claude --version 2>&1 || echo "unknown")
        info "  Version: $claude_ver"
    fi

    # tmux is optional (only needed for tmux backend)
    if command -v tmux &>/dev/null; then
        ok "tmux: $(tmux -V 2>&1)"
    else
        info "tmux: not installed (optional, needed for tmux backend)"
    fi

    # ─────────────────────────────────────────────────────────────────────────
    section "Python Environment"

    if [ -d "$SCRIPT_DIR/venv" ]; then
        ok "Virtual environment exists"

        # Check required packages
        source "$SCRIPT_DIR/venv/bin/activate" 2>/dev/null || true

        for pkg in flask flask_sock yaml requests; do
            if python3 -c "import $pkg" 2>/dev/null; then
                ok "Python package: $pkg"
            else
                fail "Python package: $pkg (missing)"
            fi
        done

        deactivate 2>/dev/null || true
    else
        fail "Virtual environment not found"
        info "  Run: ./install.sh"
    fi

    # ─────────────────────────────────────────────────────────────────────────
    section "Configuration"

    if [ -f "$SCRIPT_DIR/config.yaml" ]; then
        ok "config.yaml exists"

        # Validate YAML syntax
        if python3 -c "import yaml; yaml.safe_load(open('$SCRIPT_DIR/config.yaml'))" 2>/dev/null; then
            ok "config.yaml is valid YAML"
        else
            fail "config.yaml has syntax errors"
        fi

        # Check for placeholder values
        if grep -q 'changeme\|your-secret' "$SCRIPT_DIR/config.yaml" 2>/dev/null; then
            warn "config.yaml may have placeholder values (changeme, your-secret)"
            info "  Run ./install.sh to generate secure credentials"
        fi

        # Check ntfy topic
        local topic=$(grep 'topic_prefix:' "$SCRIPT_DIR/config.yaml" 2>/dev/null | head -1 | sed 's/.*topic_prefix:[[:space:]]*"\([^"]*\)".*/\1/' || true)
        if [ -n "$topic" ]; then
            if [ "$topic" = "claude" ] || [ "$topic" = "claude-yourname" ]; then
                warn "ntfy topic_prefix is too generic: $topic"
                info "  Use a unique prefix like 'claude-$(whoami)-$(hostname -s)'"
            else
                ok "ntfy topic_prefix: $topic"
            fi
        fi
    else
        fail "config.yaml not found"
        info "  Run: cp config.yaml.example config.yaml"
    fi

    # ─────────────────────────────────────────────────────────────────────────
    section "Network"

    local port=$(grep 'port:' "$SCRIPT_DIR/config.yaml" 2>/dev/null | head -1 | sed 's/.*port:[[:space:]]*//' | tr -d ' ' || echo "8765")

    # Check if port is in use
    if lsof -i ":$port" &>/dev/null; then
        local proc=$(lsof -i ":$port" -t 2>/dev/null | head -1)
        local proc_name=$(ps -p "$proc" -o comm= 2>/dev/null || echo "unknown")
        if [[ "$proc_name" == *"python"* ]]; then
            ok "Port $port in use by server (PID: $proc)"
        else
            warn "Port $port in use by: $proc_name (PID: $proc)"
        fi
    else
        ok "Port $port is available"
    fi

    # Get local IP
    local ip=$(ipconfig getifaddr en0 2>/dev/null || echo "")
    if [ -n "$ip" ]; then
        ok "Local IP: $ip"
        info "  Access URL: http://$ip:$port/"
    else
        warn "Could not determine local IP (en0)"
        info "  Try: ipconfig getifaddr en1"
    fi

    # ─────────────────────────────────────────────────────────────────────────
    section "Ghostty (macOS)"

    if [[ "$(uname)" == "Darwin" ]]; then
        # Check if Ghostty is installed
        if [ -d "/Applications/Ghostty.app" ]; then
            ok "Ghostty.app installed"

            # Check if running
            if pgrep -f "Ghostty.app" &>/dev/null; then
                ok "Ghostty is running"
            else
                info "Ghostty is not running"
            fi

            # Check accessibility permissions
            # This is tricky - we can try to use the API and see if it fails
            if python3 -c "
from ApplicationServices import AXUIElementCreateApplication
from Quartz import CGWindowListCopyWindowInfo, kCGWindowListOptionOnScreenOnly, kCGNullWindowID
import subprocess
result = subprocess.run(['pgrep', '-f', 'Ghostty.app'], capture_output=True)
if result.returncode == 0:
    pid = int(result.stdout.decode().strip().split()[0])
    app = AXUIElementCreateApplication(pid)
    # If we can create the element, we likely have permission
    print('ok')
" 2>/dev/null | grep -q "ok"; then
                ok "Accessibility API accessible"
            else
                warn "Accessibility permissions may be missing"
                info "  System Settings > Privacy & Security > Accessibility"
                info "  Add Terminal.app (or your terminal app)"
            fi
        else
            info "Ghostty not installed (optional)"
        fi
    else
        info "Ghostty: macOS only (skipped)"
    fi

    # ─────────────────────────────────────────────────────────────────────────
    section "tmux Backend"

    if command -v tmux &>/dev/null; then
        local sessions=$(tmux list-sessions 2>/dev/null || true)
        if [ -n "$sessions" ]; then
            local count=$(echo "$sessions" | wc -l | tr -d ' ')
            ok "tmux has $count session(s)"
        else
            info "No tmux sessions running"
        fi
    fi

    # ─────────────────────────────────────────────────────────────────────────
    section "Server Status"

    local server_pid=$(pgrep -f "python3.*server.py" 2>/dev/null | head -1 || true)
    if [ -n "$server_pid" ]; then
        ok "Server running (PID: $server_pid)"

        # Check log file
        if [ -f "$SCRIPT_DIR/server.log" ]; then
            local log_size=$(du -h "$SCRIPT_DIR/server.log" 2>/dev/null | cut -f1)
            local last_line=$(tail -1 "$SCRIPT_DIR/server.log" 2>/dev/null || true)
            ok "Log file: $log_size"
            if echo "$last_line" | grep -qi "error"; then
                warn "Recent log contains errors"
                info "  Run: ./cc-logs -e"
            fi
        fi
    else
        info "Server not running"
        info "  Start with: ./start.sh"
    fi

    # ─────────────────────────────────────────────────────────────────────────
    section "Notifications"

    # Test ntfy connectivity
    local ntfy_server=$(grep -A10 'ntfy:' "$SCRIPT_DIR/config.yaml" 2>/dev/null | grep 'server:' | head -1 | sed 's/.*server:[[:space:]]*"\([^"]*\)".*/\1/' || echo "https://ntfy.sh")
    if curl -s --max-time 5 "$ntfy_server" >/dev/null 2>&1; then
        ok "ntfy server reachable: $ntfy_server"
    else
        warn "Cannot reach ntfy server: $ntfy_server"
    fi

    # ─────────────────────────────────────────────────────────────────────────
    echo ""
    echo -e "${BLUE}═══════════════════════════════════════════${NC}"

    if [ $ISSUES -gt 0 ]; then
        echo -e "${RED}${BOLD}Found $ISSUES issue(s)${NC} and ${YELLOW}$WARNINGS warning(s)${NC}"
        exit 1
    elif [ $WARNINGS -gt 0 ]; then
        echo -e "${GREEN}${BOLD}No issues${NC}, ${YELLOW}$WARNINGS warning(s)${NC}"
        exit 0
    else
        echo -e "${GREEN}${BOLD}All checks passed!${NC}"
        exit 0
    fi
}

main "$@"
