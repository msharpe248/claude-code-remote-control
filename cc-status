#!/bin/bash
# cc-status - Show Claude Code remote control session status
#
# Detects running Claude instances, their session names, and backend type.

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Check if Ghostty is running
is_ghostty_running() {
    pgrep -f "Ghostty.app" >/dev/null 2>&1
}

# Check if tmux is available and has sessions
get_tmux_sessions() {
    if command -v tmux &>/dev/null; then
        tmux list-sessions -F "#{session_name}" 2>/dev/null || true
    fi
}

# Find claude processes
# Output format: pid|tty
get_claude_sessions() {
    # Find all processes - we'll filter carefully
    local all_pids=$(pgrep -f "claude" 2>/dev/null | head -30 || true)

    # Track which PIDs we've already processed (to avoid duplicates)
    local processed_pids=""

    for pid in $all_pids; do
        # Skip if already processed
        [[ "$processed_pids" == *"|$pid|"* ]] && continue

        local cmdline=$(ps -p "$pid" -o args= 2>/dev/null || true)
        [ -z "$cmdline" ] && continue

        # Skip non-claude processes (server, tools, grep, etc.)
        if [[ "$cmdline" == *"server.py"* ]] || \
           [[ "$cmdline" == *"cc-status"* ]] || \
           [[ "$cmdline" == *"cc-diagnose"* ]] || \
           [[ "$cmdline" == *"cc-test-notify"* ]] || \
           [[ "$cmdline" == *"cc-logs"* ]] || \
           [[ "$cmdline" == *"pgrep"* ]] || \
           [[ "$cmdline" == *"grep"* ]]; then
            continue
        fi

        # Check if this is the actual claude binary
        # Match: /path/to/claude, or just "claude" at start
        if [[ "$cmdline" =~ /claude[[:space:]] ]] || [[ "$cmdline" =~ ^claude[[:space:]] ]] || \
           [[ "$cmdline" =~ /claude$ ]] || [[ "$cmdline" == "claude" ]]; then

            processed_pids="$processed_pids|$pid|"

            # Get TTY for this process
            local tty=$(ps -p "$pid" -o tty= 2>/dev/null | tr -d ' ' || echo "??")

            echo "$pid|$tty"
        fi
    done
}

# Check if server is running
get_server_status() {
    local server_pid=$(pgrep -f "python.*server.py" 2>/dev/null | head -1 || true)
    if [ -n "$server_pid" ]; then
        echo "$server_pid"
    fi
}

# Main
main() {
    echo -e "${BOLD}${BLUE}Claude Code Remote Control - Status${NC}"
    echo -e "${BLUE}════════════════════════════════════${NC}"
    echo ""

    # Backend detection - query server if running, else detect locally
    echo -e "${BOLD}Backend:${NC}"
    local backend="none"
    local server_pid=$(get_server_status)

    if [ -n "$server_pid" ]; then
        # Get backend info from server
        local port=$(grep 'port:' "$SCRIPT_DIR/config.yaml" 2>/dev/null | head -1 | sed 's/.*port:[[:space:]]*//' | tr -d ' ' || echo "8765")
        local server_backend=$(curl -s --max-time 2 "http://localhost:$port/api/status" 2>/dev/null | \
            python3 -c "import sys,json; print(json.load(sys.stdin).get('backend','unknown'))" 2>/dev/null || echo "")
        if [ -n "$server_backend" ] && [ "$server_backend" != "unknown" ]; then
            echo -e "  ${GREEN}●${NC} $server_backend"
            backend="$server_backend"
        fi
    fi

    # Fall back to local detection if server not available
    if [ "$backend" = "none" ]; then
        if is_ghostty_running; then
            echo -e "  ${GREEN}●${NC} Accessibility API (Ghostty): ${GREEN}available${NC}"
            backend="accessibility"
        else
            echo -e "  ${YELLOW}○${NC} Accessibility API (Ghostty): not running"
        fi

        local tmux_sessions=$(get_tmux_sessions)
        if [ -n "$tmux_sessions" ]; then
            local count=$(echo "$tmux_sessions" | wc -l | tr -d ' ')
            echo -e "  ${GREEN}●${NC} tmux: ${GREEN}$count session(s)${NC}"
            if [ "$backend" = "none" ]; then
                backend="tmux"
            fi
        else
            if command -v tmux &>/dev/null; then
                echo -e "  ${YELLOW}○${NC} tmux: no sessions"
            else
                echo -e "  ${RED}○${NC} tmux: not installed"
            fi
        fi
    fi
    echo ""

    # Server status
    echo -e "${BOLD}Server:${NC}"
    local server_pid=$(get_server_status)
    if [ -n "$server_pid" ]; then
        local port=$(grep 'port:' "$SCRIPT_DIR/config.yaml" 2>/dev/null | head -1 | sed 's/.*port:[[:space:]]*//' | tr -d ' ' || echo "8765")
        local ip=$(ipconfig getifaddr en0 2>/dev/null || echo "localhost")
        echo -e "  ${GREEN}●${NC} Running (PID: $server_pid)"
        echo -e "  ${CYAN}→${NC} http://$ip:$port/"
    else
        echo -e "  ${YELLOW}○${NC} Not running"
        echo -e "  ${CYAN}→${NC} Start with: ./start.sh"
    fi
    echo ""

    # Claude sessions - get from server API which distinguishes hooked vs detected
    local hooked_sessions=""
    local other_sessions=""
    if [ -n "$server_pid" ]; then
        local port=$(grep 'port:' "$SCRIPT_DIR/config.yaml" 2>/dev/null | head -1 | sed 's/.*port:[[:space:]]*//' | tr -d ' ' || echo "8765")
        # Query /api/sessions which provides source info (hooks vs process)
        local api_response=$(curl -s --max-time 2 "http://localhost:$port/api/sessions" 2>/dev/null || true)
        if [ -n "$api_response" ]; then
            hooked_sessions=$(echo "$api_response" | python3 -c "
import sys,json
try:
    d=json.load(sys.stdin)
    for s in d.get('sessions',[]):
        if s.get('source')=='hooks':
            print(s.get('display_name','unknown'))
except: pass
" 2>/dev/null || true)
            other_sessions=$(echo "$api_response" | python3 -c "
import sys,json
try:
    d=json.load(sys.stdin)
    for s in d.get('sessions',[]):
        if s.get('source')=='process':
            print(f\"{s.get('display_name','unknown')}|{s.get('pid','')}|{s.get('hook_status','none')}\")
except: pass
" 2>/dev/null || true)
        fi
    fi

    echo -e "${BOLD}Active Sessions (via hooks):${NC}"
    if [ -n "$hooked_sessions" ]; then
        echo "$hooked_sessions" | while read -r sess; do
            [ -n "$sess" ] && echo -e "  ${BOLD}${YELLOW}✻${NC} ${BOLD}$sess${NC}"
        done
    else
        echo -e "  ${YELLOW}○${NC} None"
        if [ -z "$server_pid" ]; then
            echo -e "  ${CYAN}→${NC} Start server to see hooked sessions"
        else
            echo -e "  ${CYAN}→${NC} Configure hooks in ~/.claude/settings.json"
        fi
    fi
    echo ""

    # Show other Claude instances (detected but not hooked)
    if [ -n "$other_sessions" ]; then
        echo -e "${BOLD}Other Claude Instances:${NC} ${YELLOW}(no hooks)${NC}"
        echo "$other_sessions" | while IFS='|' read -r name pid hook_status; do
            if [ -n "$name" ]; then
                echo -e "  ${YELLOW}○${NC} $name (PID: $pid)"
            fi
        done
        echo ""
    fi

    # tmux session details (if any)
    if [ -n "$tmux_sessions" ]; then
        echo -e "${BOLD}tmux Sessions:${NC}"
        echo "$tmux_sessions" | while read -r sess; do
            # Check if Claude is running in this session
            local has_claude=""
            if tmux capture-pane -t "$sess" -p 2>/dev/null | grep -q "claude\|Claude"; then
                has_claude="${GREEN}(claude)${NC}"
            fi
            echo -e "  ${CYAN}●${NC} $sess $has_claude"
        done
        echo ""
    fi

    # Config info
    if [ -f "$SCRIPT_DIR/config.yaml" ]; then
        local notify_mode=$(grep '^[[:space:]]*mode:' "$SCRIPT_DIR/config.yaml" 2>/dev/null | head -1 | sed 's/.*mode:[[:space:]]*"\([^"]*\)".*/\1/' || echo "unknown")
        local ntfy_enabled=$(grep -A5 'ntfy:' "$SCRIPT_DIR/config.yaml" 2>/dev/null | grep 'enabled:' | head -1 | sed 's/.*enabled:[[:space:]]*//' || echo "false")
        echo -e "${BOLD}Config:${NC}"
        echo -e "  Notification mode: ${CYAN}$notify_mode${NC}"
        echo -e "  ntfy enabled: ${CYAN}$ntfy_enabled${NC}"
    fi
}

main "$@"
